
function toMinimapLen(val) {
	return val * (config.minimap.tileS / config.map.tileS);
}
 
function toMinimapX(posX) {
	return toMinimapLen(posX) - config.viewport.width / 2 + config.minimap.left;
}

function toMinimapY(posY) {
	return toMinimapLen(posY) - config.viewport.height / 2 + config.minimap.top;
}

function Game() {							
	Engine.Node.call(this);

	this.level = [[[115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115]], [[115, 138, 167], [255, 255, 255], [255, 255, 255], [255, 255, 255], [115, 138, 167], [115, 138, 167], [149, 167, 115], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115]], [[115, 138, 167], [115, 138, 167], [115, 138, 167], [255, 255, 255], [255, 255, 255], [115, 138, 167], [149, 167, 115], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [189, 217, 136], [189, 217, 136], [255, 255, 255], [149, 167, 115]], [[115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [255, 255, 255], [115, 138, 167], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [189, 217, 136], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [189, 217, 136], [189, 217, 136], [255, 255, 255], [149, 167, 115]], [[115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [255, 255, 255], [115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [149, 167, 115], [189, 217, 136], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115]], [[115, 138, 167], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [115, 138, 167], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [255, 255, 255], [149, 167, 115], [149, 167, 115], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115]], [[115, 138, 167], [255, 255, 255], [154, 115, 167], [255, 255, 255], [154, 115, 167], [255, 255, 255], [154, 115, 167], [255, 255, 255], [154, 115, 167], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115], [149, 167, 115], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115]], [[115, 138, 167], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [115, 138, 167], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [229, 203, 100], [229, 203, 100], [229, 203, 100], [149, 167, 115], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115]], [[115, 138, 167], [255, 255, 255], [255, 255, 255], [154, 115, 167], [255, 255, 255], [154, 115, 167], [255, 255, 255], [154, 115, 167], [255, 255, 255], [255, 255, 255], [115, 138, 167], [229, 203, 100], [229, 203, 100], [229, 203, 100], [229, 203, 100], [229, 203, 100], [229, 203, 100], [255, 255, 255], [229, 203, 100], [149, 167, 115], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115]], [[115, 138, 167], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [229, 203, 100], [149, 167, 115], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115]], [[115, 138, 167], [255, 255, 255], [154, 115, 167], [255, 255, 255], [154, 115, 167], [255, 255, 255], [154, 115, 167], [255, 255, 255], [154, 115, 167], [255, 255, 255], [115, 138, 167], [229, 203, 100], [229, 203, 100], [229, 203, 100], [229, 203, 100], [229, 203, 100], [229, 203, 100], [255, 255, 255], [229, 203, 100], [149, 167, 115], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115]], [[115, 138, 167], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [115, 138, 167], [255, 255, 255], [255, 255, 255], [255, 255, 255], [229, 203, 100], [255, 255, 255], [229, 203, 100], [149, 167, 115], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115]], [[115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [255, 255, 255], [115, 138, 167], [115, 138, 167], [255, 255, 255], [115, 138, 167], [115, 138, 167], [115, 138, 167], [255, 255, 255], [115, 138, 167], [255, 255, 255], [154, 87, 100], [255, 255, 255], [207, 185, 95], [255, 255, 255], [207, 185, 95], [149, 167, 115], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115]], [[108, 126, 171], [255, 255, 255], [255, 255, 255], [115, 138, 167], [255, 255, 255], [115, 138, 167], [115, 138, 167], [255, 255, 255], [255, 255, 255], [115, 138, 167], [255, 255, 255], [255, 255, 255], [115, 138, 167], [255, 255, 255], [255, 255, 255], [255, 255, 255], [207, 185, 95], [255, 255, 255], [207, 185, 95], [149, 167, 115], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115]], [[108, 126, 171], [70, 76, 136], [255, 255, 255], [115, 138, 167], [255, 255, 255], [73, 86, 121], [73, 86, 121], [73, 86, 121], [255, 255, 255], [115, 138, 167], [255, 255, 255], [115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [255, 255, 255], [193, 173, 94], [255, 255, 255], [193, 173, 94], [149, 167, 115], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115]], [[108, 126, 171], [108, 126, 171], [255, 255, 255], [255, 255, 255], [255, 255, 255], [85, 91, 148], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [115, 138, 167], [255, 255, 255], [193, 173, 94], [255, 255, 255], [193, 173, 94], [149, 167, 115], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115]], [[148, 165, 208], [255, 255, 255], [255, 255, 255], [115, 138, 167], [255, 255, 255], [85, 91, 148], [255, 255, 255], [70, 76, 136], [85, 91, 148], [70, 76, 136], [255, 255, 255], [70, 76, 136], [70, 76, 136], [255, 255, 255], [115, 138, 167], [255, 255, 255], [169, 155, 97], [255, 255, 255], [169, 155, 97], [149, 167, 115], [255, 255, 255], [255, 255, 255], [255, 255, 255], [149, 167, 115]], [[148, 165, 208], [148, 165, 208], [108, 126, 171], [115, 138, 167], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [115, 138, 167], [255, 255, 255], [169, 155, 97], [255, 255, 255], [169, 155, 97], [149, 167, 115], [189, 217, 136], [189, 217, 136], [189, 217, 136], [149, 167, 115]], [[115, 138, 167], [255, 255, 255], [115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [255, 255, 255], [115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [115, 138, 167], [255, 255, 255], [147, 135, 88], [255, 255, 255], [147, 135, 88], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115], [149, 167, 115]], [[123, 68, 133], [255, 255, 255], [123, 68, 133], [123, 68, 133], [123, 68, 133], [123, 68, 133], [123, 68, 133], [123, 68, 133], [255, 255, 255], [123, 68, 133], [75, 207, 190], [75, 207, 190], [75, 207, 190], [75, 207, 190], [75, 207, 190], [255, 255, 255], [75, 207, 190], [255, 255, 255], [75, 207, 190], [96, 236, 218], [96, 236, 218], [96, 236, 218], [255, 255, 255], [255, 255, 255]], [[123, 68, 133], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [123, 68, 133], [75, 207, 190], [75, 207, 190], [75, 207, 190], [255, 255, 255], [255, 255, 255], [255, 255, 255], [75, 207, 190], [255, 255, 255], [255, 255, 255], [75, 207, 190], [96, 236, 218], [96, 236, 218], [255, 255, 255], [255, 255, 255]], [[123, 68, 133], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [123, 68, 133], [75, 207, 190], [75, 207, 190], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [75, 207, 190], [255, 255, 255], [255, 255, 255], [75, 207, 190], [96, 236, 218], [255, 255, 255], [255, 255, 255]], [[123, 68, 133], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [171, 117, 181], [255, 255, 255], [255, 255, 255], [123, 68, 133], [75, 207, 190], [255, 255, 255], [255, 255, 255], [75, 207, 190], [75, 207, 190], [75, 207, 190], [255, 255, 255], [255, 255, 255], [75, 207, 190], [255, 255, 255], [255, 255, 255], [75, 207, 190], [255, 255, 255], [255, 255, 255]], [[123, 68, 133], [255, 255, 255], [255, 255, 255], [238, 186, 248], [214, 141, 227], [214, 141, 227], [255, 255, 255], [255, 255, 255], [255, 255, 255], [123, 68, 133], [75, 207, 190], [255, 255, 255], [75, 207, 190], [255, 255, 255], [255, 255, 255], [255, 255, 255], [75, 207, 190], [255, 255, 255], [75, 207, 190], [75, 207, 190], [255, 255, 255], [75, 207, 190], [255, 255, 255], [255, 255, 255]], [[123, 68, 133], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [171, 117, 181], [255, 255, 255], [255, 255, 255], [123, 68, 133], [75, 207, 190], [255, 255, 255], [75, 207, 190], [255, 255, 255], [96, 236, 218], [255, 255, 255], [75, 207, 190], [255, 255, 255], [255, 255, 255], [75, 207, 190], [255, 255, 255], [75, 207, 190], [255, 255, 255], [255, 255, 255]], [[123, 68, 133], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [123, 68, 133], [75, 207, 190], [255, 255, 255], [75, 207, 190], [255, 255, 255], [255, 255, 255], [75, 207, 190], [75, 207, 190], [255, 255, 255], [75, 207, 190], [75, 207, 190], [255, 255, 255], [75, 207, 190], [255, 255, 255], [255, 255, 255]], [[123, 68, 133], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [123, 68, 133], [75, 207, 190], [255, 255, 255], [255, 255, 255], [75, 207, 190], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [75, 207, 190], [255, 255, 255], [255, 255, 255], [75, 207, 190], [255, 255, 255], [255, 255, 255]], [[123, 68, 133], [123, 68, 133], [123, 68, 133], [123, 68, 133], [123, 68, 133], [123, 68, 133], [123, 68, 133], [123, 68, 133], [123, 68, 133], [123, 68, 133], [96, 236, 218], [75, 207, 190], [255, 255, 255], [255, 255, 255], [75, 207, 190], [75, 207, 190], [75, 207, 190], [75, 207, 190], [255, 255, 255], [255, 255, 255], [75, 207, 190], [96, 236, 218], [255, 255, 255], [255, 255, 255]], [[123, 68, 133], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [123, 68, 133], [96, 236, 218], [96, 236, 218], [75, 207, 190], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [75, 207, 190], [96, 236, 218], [96, 236, 218], [255, 255, 255], [255, 255, 255]], [[123, 68, 133], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [255, 255, 255], [123, 68, 133], [123, 68, 133], [96, 236, 218], [96, 236, 218], [96, 236, 218], [75, 207, 190], [75, 207, 190], [75, 207, 190], [75, 207, 190], [75, 207, 190], [75, 207, 190], [96, 236, 218], [96, 236, 218], [96, 236, 218], [255, 255, 255], [255, 255, 255]]];

	var slicesNum = Math.ceil(config.scene.width / config.scene.slice_width);		
	this.slices = [];
	this.floor = [];
	this.ceiling = [];
	this.debugCP = [];
	this.delta = 0;

	for(var i =0; i<slicesNum; i++) {
		this.slices.push(
			new Engine.Sprite({
				width: config.scene.slice_width,				
				x: config.scene.width * (-0.5) + i * config.scene.slice_width,
				y: 0,				
				parent : scene
			}));		
		this.ceiling.push(
			new Engine.Sprite({
				width: config.scene.slice_width,				
				x: config.scene.width * (-0.5) + i * config.scene.slice_width,
				y: 0,				
				parent : scene
			}));		
		this.floor.push(
			new Engine.Sprite({
				width: config.scene.slice_width,				
				x: config.scene.width * (-0.5) + i * config.scene.slice_width,
				y: 0,				
				parent : scene
			}));		
	}

	/* DRAW MINIMAP */
	/*
	var col;
	for(var i = 0; i<this.level.length; i++) {
		for(var j = 0; j<this.level[i].length; j++) {			

			new Engine.Sprite({
				width: config.minimap.tileS,
				height: config.minimap.tileS,
				x: (i + 0.5) * config.minimap.tileS - config.viewport.width / 2 + config.minimap.left,
				y: (j + 0.5) * config.minimap.tileS - config.viewport.height / 2 + config.minimap.top,
				color: new tinycolor({r : this.level[i][j][0], g : this.level[i][j][1], b : this.level[i][j][2]}).toRgbString(),
				parent: scene,
				opacity: 0.3
			});
		}
	}

	for(var i =0; i<slicesNum; i++)
		this.debugCP.push(
			new Engine.Sprite({
				width: 1,
				height: 1,
				x: 0,
				y: 0,
				color: "orange",
				parent : scene
			}));		

	this.playerMinimap = new Engine.Sprite({
		width: config.minimap.playerS,
		height: config.minimap.playerS,
		x: 0,
		y: 0,
		color: "red",
		parent: scene
	});

	this.playerDirection = new Engine.Sprite({
		width: 30,
		height: 1,
		x: 0,
		y: 0,
		originX: -15,
		originY: 0,		
		color: "red",
		parent: scene
	});	
	*/
}

Game.prototype = Object.create(Engine.Node.prototype);
Game.prototype.contructor = Game;

function pow2(val) {
	return val * val;
}

Game.prototype.cast = function(pos, direction, rayNum, deltaAngle) {	
	var dAng = direction.angle() % (Math.PI * 2);	
	var self = this;
	if(dAng < 0) dAng += Math.PI * 2;				

	var yFacingUp = dAng > Math.PI && dAng < Math.PI * 2;		
	var xFacingLeft = dAng > Math.PI * 0.5 && dAng < Math.PI * 1.5;
	var angSin = Math.sin(dAng), angCos = Math.cos(dAng);
	var addY = 0;
	var addX = 0;

	var isWall = function(xC, yC) {	
		var xC = Math.floor(xC / config.map.tileS) + addX;		
		var yC = Math.floor(yC / config.map.tileS) + addY;		
				
		if(yC < 0 || yC >= self.level.length || xC < 0 || xC >= self.level.length)
			return [0, 0, 0];	
		if(self.level[xC][yC] == null ||
		   (self.level[xC][yC][0] == 255 &&
			self.level[xC][yC][1] == 255 &&
			self.level[xC][yC][2] == 255))
			return false;	
		return self.level[xC][yC];
	};

	var Ay = yFacingUp ?  Math.floor(pos.y / config.map.tileS) * config.map.tileS : 
						  Math.ceil(pos.y / config.map.tileS) * config.map.tileS;							 
	var Ax = pos.x + (Ay - pos.y) * (angCos / angSin);				
	var Ya = yFacingUp ? -config.map.tileS : config.map.tileS;		
	var Xa = Ya * (angCos / angSin);			
	
	var Bx = xFacingLeft ? Math.floor(pos.x / config.map.tileS) * config.map.tileS : 
						   Math.ceil(pos.x / config.map.tileS) * config.map.tileS;		
	var By = pos.y + (Bx - pos.x) * (angSin / angCos);		
	var Xb = xFacingLeft ? -config.map.tileS : config.map.tileS;	
	var Yb = Xb * (angSin / angCos);	
			
	var finLen = 0;
	var bColValue;
	var aColValue;

	if(yFacingUp)
		addY = -1;
	do {							
		if(aColValue = isWall(Ax, Ay)) {
			finLen = Math.sqrt(pow2(Ax - pos.x) + pow2(Ay - pos.y));						 			
			break;
		} else { 
			Ax += Xa;
			Ay += Ya;				
		}		
	} while(true);

	addY = 0;
	if(xFacingLeft)
		addX = -1;
	do {				
		if(bColValue = isWall(Bx, By))  {
			var finLen2 = Math.sqrt(pow2(Bx - pos.x) + pow2(By - pos.y));
			if(finLen2 < finLen) {
				finLen = finLen2;
				aColValue = bColValue;
			}
			break;						 			
		} else {
			Bx += Xb;
			By += Yb;	
		}		
	} while(true);		

	/*
	game.debugCP[rayNum].width = toMinimapLen(finLen);
	game.debugCP[rayNum].x = toMinimapX(pos.x) + game.debugCP[rayNum].width / 2;
	game.debugCP[rayNum].y = toMinimapY(pos.y);		
	game.debugCP[rayNum].rotation = -direction.angle();
	game.debugCP[rayNum].originX = -game.debugCP[rayNum].width / 2;
	*/

	return {len: finLen, col: aColValue};	
};

Game.prototype.onStep = function() {	
	this.delta += 0.1;
	var w = this.slices.length;		
	var vec = new Victor(0, 0);	

	for(var i = 0; i < w; i++) {		
		var deltaAngle = degrees2radian(config.player.FOV * (i / w - 0.5));
		vec.copy(player.direction).rotate(deltaAngle).normalize();

		var rayData = this.cast(player.pos, vec, i, deltaAngle);		

		var rgb = new tinycolor({r : rayData.col[0], 
								 g : rayData.col[1], 
								 b : rayData.col[2]});
		var hsv = rgb.toHsv();		
		hsv.v -= Math.max(Math.min(rayData.len, config.player.lightDistance), 0) / config.player.lightDistance;
		rgb = new tinycolor(hsv);		

		this.slices[i].color = rgb.toRgbString();	
		this.slices[i].height = 130 / (rayData.len * Math.cos(deltaAngle)) * config.player.far;

		this.floor[i].color = "rgb(20, 20, 20)";	
		this.floor[i].height = (config.scene.height - this.slices[i].height) / 2;
		this.floor[i].y = (this.floor[i].height + this.slices[i].height) / 2;

		this.ceiling[i].color = "rgb(40, 40, 40)";	
		this.ceiling[i].height = (config.scene.height - this.slices[i].height) / 2;
		this.ceiling[i].y = (this.ceiling[i].height - config.scene.height) / 2;

	}
};

Game.prototype.show = function() {
	this.parent = scene;	
	
	var self = this;
	this.timer = new Engine.Timer({
		type: Engine.Timer.VSYNC,
		duration: Infinity,
		on: {
			step: self.onStep.bind(this)
		}
	});
	this.timer.play();
};

Game.prototype.hide = function() {
	this.parent = null;
	this.timer.stop();
	this.timer = null;
}